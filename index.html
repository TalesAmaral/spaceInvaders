<!DOCTYPE html>
<html>
	<head>
		<script src=" https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js "></script>
	</head>
	<body>

		<script>
			const w = 800;
			const h = 600;
			const mapWidth = 1024;
			const mapHeight = 2048;
			let config = {
				width: w,
				height: h,
				type: Phaser.AUTO,
				physics: {
					default: 'arcade',
				},
				scene: {
					preload:preload,
					create: create,
					update: update,
				}
			};

			const game = new Phaser.Game(config);
			const velocidadeJogador = 150;
			let enemyGroup;
			let enemyGroupBullets;
			let playerGroupBullets;
			
			let player;
			let cursors;

			function preload() {
				this.load.image('ship', 'fmship.png');				
				this.load.image('space', 'space.png');
				this.load.image('bala', 'bullet.png');
			}

			function create() {
				addSprites(this)
				createGroups(this)
				addInputs(this)
				addPhysics(this)
				setCamera(this)
				startGame(this)
			}
			
			function update() {
				atualizarVelocidade(player, 0, 0)

				const leftIsPressed = cursors.left.isDown
				const rightIsPressed = cursors.right.isDown
				const upIsPressed = cursors.up.isDown
				const downIsPressed = cursors.down.isDown
				const spaceIsPressed = cursors.space.isDown
				
				if (leftIsPressed) {
					player.angle -= 5
				}
				else if (rightIsPressed) {
					player.angle += 5
				}

				const angle = player.rotation - Math.PI/2;

				if (upIsPressed) {	
					atualizarVelocidade(player, velocidadeJogador, angle)
				} else if (downIsPressed) {
					atualizarVelocidade(player, -velocidadeJogador, angle)
				}

				if (spaceIsPressed) {
					shoot(this, player, playerGroupBullets);
				}
				moveEnemy(this);
			}

			function startGame(phaser) {
				setInterval(() => {
					const { enemyPosX, enemyPosY } = generateRandomEnemyPos();
					enemyGroup.create(enemyPosX, enemyPosY, "ship");
				}, 1000);
			}

			function addSprites(phaser) {
				phaser.add.tileSprite(0, 0, mapWidth, mapHeight, 'space').setOrigin(0);
				player = phaser.physics.add.image(mapWidth/2, mapHeight/2, 'ship');
			}

			function createGroups(phaser) {
				enemyGroup = phaser.physics.add.group();
				enemyGroupBullets = phaser.physics.add.group();
				playerGroupBullets = phaser.physics.add.group();
			}

			function addPhysics(phaser) {
				phaser.physics.add.existing(player);

				phaser.physics.add.collider(
					playerGroupBullets,
					enemyGroup,
					(bullet, enemy) => {enemy.destroy(); bullet.destroy()}
				);		
				phaser.physics.world.on('worldbounds', (body) => {
					if (playerGroupBullets.contains(body.gameObject) || enemyGroupBullets.contains(body.gameObject)){
						body.gameObject.destroy();
					}
				});
			}
			
			function addInputs(phaser) {
				cursors = phaser.input.keyboard.createCursorKeys();
			}

			function setCamera(phaser) {
				phaser.cameras.main.setBounds(0, 0, mapWidth, mapHeight);
				phaser.physics.world.setBounds(0, 0, mapWidth, mapHeight);
				player.setCollideWorldBounds(true);
				phaser.cameras.main.startFollow(player, true);
			}

			function generateRandomEnemyPos() {
				const enemyPosX = Math.floor(Math.random() * mapWidth)
				const enemyPosY = Math.abs(enemyPosX - player.x) < w/2 ? (Math.random() * (mapHeight-h) + player.y + h/2) % mapHeight : Math.random() * (mapHeight)
				return { enemyPosX, enemyPosY }
			}

			function shoot(phaser,entidade, bulletGroup) {
				const angle = entidade.rotation - Math.PI/2;
				const velBala = 1000;
				const bala = 	bulletGroup.create(entidade.x, entidade.y, "bala");
				bala.setScale(.04)
				bala.angle = entidade.angle;
				
				phaser.children.bringToTop(entidade);
				bulletGroup.add(bala);
				atualizarVelocidade(bala, velBala, angle);

				bala.setCollideWorldBounds(true);
				bala.body.onWorldBounds = true;
			}


			function atualizarVelocidade(entidade, vel, angle){
				entidade.setVelocityY(vel * Math.sin(angle));
				entidade.setVelocityX(vel * Math.cos(angle));
			}
			function modulo(x,y){
				return (x**2 +y**2)**0.5
			}
			function moveEnemy(phaser){
				enemyGroup.getChildren().forEach(function(enemy) {

					const angle =  Phaser.Math.Angle.Between(enemy.x,enemy.y, player.x, player.y);
					enemy.setRotation(angle);
					enemy.angle+=90;
					shoot(phaser,enemy, enemyGroupBullets);
		

				});
			}
		</script>

	</body>
</html>
